# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "40 1 * * *"
  workflow_dispatch:

env:
  REPO_URL: "https://github.com/${{ github.repository }}.git"
  AUTH_REPO_URL: "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
  PASSWORD: ${{ secrets.ACCESS_PASSWORD }}
  NAME: ${{ vars.NAME }}
  EMAIL: ${{ vars.EMAIL }}
  MODEL_NAME: ${{ vars.MODEL_NAME }}
  CATEGORIES: ${{ vars.CATEGORIES }}
  MAX_WORKERS: ${{ vars.MAX_WORKERS || '1' }}
  LANGUAGE: ${{ vars.LANGUAGE || 'Chinese' }}
  DEFAULT_KEYWORDS: ${{ vars.DEFAULT_KEYWORDS || ''}}
  DEFAULT_AUTHORS: ${{ vars.DEFAULT_AUTHORS || '' }}

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Clone main branch as a separate repo
      run: |
        git clone --branch main $AUTH_REPO_URL ref-main

    - name: Clone data branch as a separate repo
      run: |
        git config --global user.email "$EMAIL"
        git config --global user.name "$NAME"
                
        echo "è®¾ç½® data åˆ†æ”¯... / Setting up data branch..."
        
        # æ£€æŸ¥ data åˆ†æ”¯æ˜¯å¦å­˜åœ¨ / Check if data branch exists
        if git ls-remote --heads "$REPO_URL" data | grep -q data; then
          echo "data åˆ†æ”¯å·²å­˜åœ¨ï¼Œå…‹éš† data åˆ†æ”¯ / Data branch exists, switching to data branch"
          git clone --branch data $AUTH_REPO_URL ref-data
        else
          echo "data åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯ / Data branch does not exist, creating new branch"
          git clone --no-checkout $AUTH_REPO_URL ref-data
          
          # åˆ›å»ºç©ºçš„ data åˆ†æ”¯ / Create empty data branch
          cd ref-data
          git checkout --orphan data
          git rm -rf --cached . >/dev/null 2>&1 || true
          # ç¡®ä¿ data ç›®å½•å­˜åœ¨ / Ensure data directory exists
          mkdir -p data
          echo "# Data Branch" > README.md
          git add README.md
          git commit -m "chore: initialize data branch"
          git push origin data
        fi

    - name: Install dependencies
      run: |
        cd ref-main
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync
        
    - name: Crawl arXiv papers
      id: crawl_step
      run: |
        cd ref-main
        source .venv/bin/activate

        today=$(date -u "+%Y-%m-%d")
        echo "å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡... / Starting to crawl $today arXiv papers..."
        echo "çˆ¬å–ç±»åˆ«: $CATEGORIES / Crawling categories: $CATEGORIES"
        
        # æ£€æŸ¥ä»Šæ—¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚å­˜åœ¨åˆ™åˆ é™¤ / Check if today's file exists, delete if found
        if [ -f "../ref-data/data/${today}.jsonl" ]; then
            echo "ğŸ—‘ï¸ å‘ç°ä»Šæ—¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤é‡æ–°ç”Ÿæˆ... / Found existing today's file, deleting for fresh start..."
            rm "../ref-data/data/${today}.jsonl"
            echo "âœ… å·²åˆ é™¤ç°æœ‰æ–‡ä»¶ï¼š../ref-data/data/${today}.jsonl / Deleted existing file: ../ref-data/data/${today}.jsonl"
        else
            echo "ğŸ“ ä»Šæ—¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ–°å»º... / Today's file doesn't exist, ready to create new one..."
        fi

        cd daily_arxiv

        # ä½¿ç”¨Scrapyçˆ¬å–
        # Use Scrapy to crawl
        scrapy crawl arxiv -o ../../ref-data/data/${today}.jsonl
        
        # æ£€æŸ¥çˆ¬å–æ˜¯å¦æˆåŠŸ / Check if crawling was successful
        if [ ! -f "../../ref-data/data/${today}.jsonl" ]; then
            echo "çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶ / Crawling failed, no data file generated"
            exit 1
        fi
        
        echo "crawl_date=$today" >> $GITHUB_OUTPUT
        echo "çˆ¬å–å®Œæˆ / Crawling completed"
        
    - name: Check for duplicates
      id: dedup_check
      run: |
        cd ref-main
        source .venv/bin/activate
        
        cd daily_arxiv
        echo "æ‰§è¡Œå»é‡æ£€æŸ¥... / Performing intelligent deduplication check..."

        # æ‰§è¡Œå»é‡æ£€æŸ¥è„šæœ¬ / Execute intelligent deduplication check script
        set +e  # æš‚æ—¶å…è®¸å‘½ä»¤å¤±è´¥ / Temporarily allow command failure
        python daily_arxiv/check_stats.py --data ../../ref-data/data/${today}.jsonl
        
        # è·å–é€€å‡ºç  / Get exit code
        dedup_exit_code=$?
        set -e  # æ¢å¤ä¸¥æ ¼æ¨¡å¼ / Restore strict mode
        
        echo "å»é‡æ£€æŸ¥é€€å‡ºç : $dedup_exit_code / Dedup check exit code: $dedup_exit_code"
        echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT
        
        case $dedup_exit_code in
            0)
                echo "has_new_content=true" >> $GITHUB_OUTPUT
                ;;
            1)
                echo "has_new_content=false" >> $GITHUB_OUTPUT
                echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT
                ;;
            2)
                echo "has_new_content=false" >> $GITHUB_OUTPUT
                echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
                ;;
            *)
                echo "âŒ æœªçŸ¥é€€å‡ºç ï¼Œåœæ­¢å·¥ä½œæµ / Unknown exit code, stop workflow"
                echo "has_new_content=false" >> $GITHUB_OUTPUT
                echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
                ;;
        esac
        
    - name: AI Enhancement Cache
      if: steps.dedup_check.outputs.has_new_content == 'true'
      uses: actions/cache@v4
      with:
        path: ref-data/data/${{ steps.crawl_step.outputs.crawl_date }}_AI_enhanced_${{ env.LANGUAGE }}.jsonl
        key: ai-enhance-cache-${{ steps.crawl_step.outputs.crawl_date }}-${{ github.run_id }}
        restore-keys: |
          ai-enhance-cache-${{ steps.crawl_step.outputs.crawl_date }}-

    - name: AI Enhancement Processing
      id: ai_enhance
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        cd ref-main
        source .venv/bin/activate

        today=${{ steps.crawl_step.outputs.crawl_date }}
        echo "å¼€å§‹AIå¢å¼ºå¤„ç†... / Starting AI enhancement processing..."
        
        echo "ä½¿ç”¨æ¨¡å‹: $MODEL_NAME / Using model: $MODEL_NAME"
        echo "è¾“å‡ºè¯­è¨€: $LANGUAGE / Output language: $LANGUAGE"
        echo "å¹¶è¡Œå¤„ç†å·¥ä½œçº¿ç¨‹æ•°: $MAX_WORKERS / Number of parallel worker threads: $MAX_WORKERS"

        cd ai
        
        # ä½¿ç”¨AIå¤„ç†çˆ¬å–çš„æ•°æ® / Use AI to process the crawled data
        LOG_FILE=$(mktemp)
        python enhance.py --data ../../ref-data/data/${today}.jsonl --max_workers $MAX_WORKERS 2>&1 | tee $LOG_FILE
        if tail -10 "$LOG_FILE" | grep -q "AI_FAILED"; then
            echo "âŒ AIå¤„ç†å­˜åœ¨é”™è¯¯ / AI processing has errors"
        else
            echo "ai_success=true" >> $GITHUB_OUTPUT
            echo "âœ… AIå¢å¼ºå¤„ç†å®Œæˆ / AI enhancement processing completed"
        fi
        rm "$LOG_FILE"

    - name: Summary
      run: |
        if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
          echo "âœ… å·¥ä½œæµå®Œæˆï¼šå»é‡å‘ç°æ–°å†…å®¹å¹¶æˆåŠŸå¤„ç† / Workflow completed: Smart deduplication found new content and processed successfully"
        else
          case "${{ steps.dedup_check.outputs.skip_reason }}" in
            "no_new_content")
              echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šå»é‡åæ— æ–°å†…å®¹ / Workflow completed: No new content after smart deduplication"
              ;;
            "processing_error")
              echo "âš ï¸ å·¥ä½œæµå®Œæˆï¼šå»é‡å¤„ç†å‡ºé”™ / Workflow completed: Deduplication processing error"
              ;;
            "unknown_error")
              echo "âš ï¸ å·¥ä½œæµå®Œæˆï¼šæœªçŸ¥é”™è¯¯ / Workflow completed: Unknown error"
              ;;
            *)
              echo "â„¹ï¸ å·¥ä½œæµå®Œæˆï¼šæœªçŸ¥åŸå› è·³è¿‡å¤„ç† / Workflow completed: Skipped for unknown reason"
              ;;
          esac
        fi

    - name: Send WeChat Bot Notification
      if: always()
      run: |
        cd ref-main
        source .venv/bin/activate
        
        echo "ğŸ“¤ å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥... / Sending WeChat bot notification..."

        # è·å–ç¯å¢ƒå˜é‡
        WECHAT_WEBHOOK_URL="${{ secrets.WECHAT_WEBHOOK_URL }}"
        
        if [ -z "$WECHAT_WEBHOOK_URL" ]; then
          echo "âš ï¸ æœªè®¾ç½®ä¼ä¸šå¾®ä¿¡Webhook URLï¼Œè·³è¿‡æ¨é€ / WeChat webhook URL not set, skipping notification"
          exit 0
        fi

        cd notify
        
        # æ ¹æ®å·¥ä½œæµçŠ¶æ€å‘é€ä¸åŒçš„é€šçŸ¥
        if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ] && [ "${{ steps.ai_enhance.outputs.ai_success }}" = "true" ]; then
          # æˆåŠŸå¤„ç†æ–°å†…å®¹
          echo "âœ… å‘é€æˆåŠŸé€šçŸ¥ / Sending success notification"
          python wechat_bot.py --data ../../ref-data/data/${today}.jsonl --status "success" --count "-1" --webhook "$WECHAT_WEBHOOK_URL"
          
        elif [ "${{ steps.dedup_check.outputs.has_new_content }}" = "false" ]; then
          # æ— æ–°å†…å®¹
          echo "â„¹ï¸ å‘é€æ— æ–°å†…å®¹é€šçŸ¥ / Sending no content notification"
          python wechat_bot.py --data ../../ref-data/data/${today}.jsonl --status "no_content" --webhook "$WECHAT_WEBHOOK_URL"
          
        else
          # å¤„ç†å¤±è´¥
          echo "âŒ å‘é€å¤±è´¥é€šçŸ¥ / Sending error notification"
          ERROR_MSG="å·¥ä½œæµå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
          if [ "${{ steps.dedup_check.outputs.skip_reason }}" = "processing_error" ]; then
            ERROR_MSG="å»é‡å¤„ç†å‡ºé”™"
          elif [ "${{ steps.ai_enhance.outputs.ai_success }}" != "true" ]; then
            ERROR_MSG="AIå¢å¼ºå¤„ç†å¤±è´¥"
          fi
          python wechat_bot.py --data ../../ref-data/data/${today}.jsonl --status "error" --error "$ERROR_MSG" --webhook "$WECHAT_WEBHOOK_URL"
        fi
        
        echo "âœ… ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å®Œæˆ / WeChat bot notification completed"

    - name: Inject password hash into auth-config.js
      run: |
        cd ref-main

        echo "ğŸ” æ³¨å…¥å¯†ç å“ˆå¸Œåˆ° auth-config.js... / Injecting password hash into auth-config.js..."

        if [ -z "$PASSWORD" ]; then
          echo "âš ï¸  WARNING: ACCESS_PASSWORD not set in Secrets"
          echo "âš ï¸  Password protection will be DISABLED"
          echo "âš ï¸  To enable password protection, add ACCESS_PASSWORD in repository Secrets"
          echo "â„¹ï¸  Website will remain publicly accessible without authentication"

          # Use a special value that will disable authentication
          PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_SECRETS"
        else
          # Generate SHA-256 hash using openssl
          PASSWORD_HASH=$(echo -n "$PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
          echo "âœ… Password hash generated successfully"
          echo "âœ… Hash length: ${#PASSWORD_HASH} characters"
          echo "ğŸ” Password protection is ENABLED"
        fi

        # Inject hash into auth-config.js
        if [ -f "js/auth-config.js" ]; then
          # Match the assignment at the start of the line and replace the quoted value (single or double quotes)
          sed -E -i "s@passwordHash: ['\"].*['\"],@passwordHash: '${PASSWORD_HASH}',@" js/auth-config.js || true
          echo "âœ… Password hash injected/updated into js/auth-config.js"

          git add js/auth-config.js
        else
          echo "âŒ ERROR: js/auth-config.js not found!"
        fi

        echo "ğŸ” å¯†ç å“ˆå¸Œæ³¨å…¥å®Œæˆ / Authentication setup complete"

    - name: Inject default filter keywords & authors into data-config.js
      run: |
        cd ref-main

        echo "æ³¨å…¥é»˜è®¤è¿‡æ»¤å…³é”®è¯åŠä½œè€…åˆ—è¡¨åˆ° data-config.js... / Injecting default filter keywords & authors into data-config.js..."

        echo "é»˜è®¤å…³é”®è¯ / Default Keywords: $DEFAULT_KEYWORDS"
        echo "é»˜è®¤ä½œè€…åˆ—è¡¨ / Default Authors: $DEFAULT_AUTHORS"

        # Inject filter config into data-config.js
        if [ -f "js/data-config.js" ]; then
          # Replace the defaultKeywords and defaultAuthors values
          sed -i "s@defaultKeywords: .*'@defaultKeywords: '${DEFAULT_KEYWORDS}'@" js/data-config.js || true
          sed -i "s@defaultAuthors: .*'@defaultAuthors: '${DEFAULT_AUTHORS}'@" js/data-config.js || true
          echo "âœ… Default keywords and authors injected/updated into js/data-config.js"

          git add js/data-config.js
        else
          echo "âŒ ERROR: js/data-config.js not found!"
        fi

        echo "ğŸ” é»˜è®¤è¿‡æ»¤é…ç½®æ³¨å…¥å®Œæˆ / Default filter config injection complete"

    - name: Inject repository info into data-config.js
      run: |
        cd ref-main

        echo "ğŸ” æ³¨å…¥ä»“åº“ä¿¡æ¯åˆ° data-config.js... / Injecting repository info into data-config.js..."
        
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        echo "ä»“åº“æ‰€æœ‰è€…: $REPO_OWNER / Repository owner: $REPO_OWNER"
        echo "ä»“åº“åç§°: $REPO_NAME / Repository name: $REPO_NAME"
        
        # æ³¨å…¥ä»“åº“ä¿¡æ¯åˆ° data-config.js / Inject repository info into data-config.js
        if [ -f "js/data-config.js" ]; then
          sed -i "s/PLACEHOLDER_REPO_OWNER/$REPO_OWNER/g" js/data-config.js
          sed -i "s/PLACEHOLDER_REPO_NAME/$REPO_NAME/g" js/data-config.js
          echo "âœ… ä»“åº“ä¿¡æ¯å·²æ³¨å…¥åˆ° js/data-config.js / Repository info injected into js/data-config.js"
          
          git add js/data-config.js
        else
          echo "âŒ ERROR: js/data-config.js not found!"
        fi

        echo "ğŸ” æ•°æ®ä»“åº“ä¿¡æ¯æ³¨å…¥å®Œæˆ / Repository info injection complete"
       
    - name: Commit code changes to main branch
      run: |
        cd ref-main

        git config --global user.email "$EMAIL"
        git config --global user.name "$NAME"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤ / Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "ğŸŸ¡ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤ / No changes to commit"
          exit 0
        fi
        git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
        
        echo "âœ… å˜æ›´å·²æäº¤ / Changes committed"

    - name: Push code changes to main branch
      run: |
        cd ref-main
        
        # è®¾ç½®Gité…ç½®ä»¥å¤„ç†è‡ªåŠ¨åˆå¹¶ / Set Git config for automatic merging
        git config pull.rebase true
        git config rebase.autoStash true
        
        # å°è¯•æ¨é€ä»£ç å˜æ›´åˆ° main åˆ†æ”¯ / Try to push code changes to main branch
        for i in {1..3}; do
          echo "æ¨é€ä»£ç å˜æ›´å°è¯• $i / Push code changes attempt $i"
          if git push origin main; then
            echo "âœ… æ¨é€æˆåŠŸ / Push successful"
            break
          else
            echo "ğŸŸ¡ æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°å˜æ›´... / Push failed, pulling latest changes..."
            git pull origin main --no-edit || true
            if [ $i -eq 3 ]; then
              echo "âŒ 3æ¬¡å°è¯•åæ¨é€å¤±è´¥ / Failed to push after 3 attempts"
            fi
          fi
        done

    - name: Setup and commit to data branch
      if: steps.ai_enhance.outputs.ai_success == 'true'
      run: |
        cd ref-data

        git config --global user.email "$EMAIL"
        git config --global user.name "$NAME"

        echo "æ›´æ–°æ–‡ä»¶åˆ—è¡¨... / Updating file list..."
        ls data/*.jsonl | sed 's|data/||' > file-list.txt
        
        # åªæ·»åŠ æ•°æ®æ–‡ä»¶ / Only add data files
        git add data/*.jsonl 2>/dev/null || true
        git add file-list.txt 2>/dev/null || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å˜æ›´éœ€è¦æäº¤ / Check if there are data changes to commit
        if git diff --staged --quiet; then
          echo "ğŸŸ¡ æ²¡æœ‰æ•°æ®å˜æ›´éœ€è¦æäº¤ / No data changes to commit"
        else
          today=${{ steps.crawl_step.outputs.crawl_date }}
          git commit -m "update: $today arXiv papers"
          echo "âœ… æ•°æ®å˜æ›´å·²æäº¤åˆ° data åˆ†æ”¯ / Data changes committed to data branch"
        fi

    - name: Push data changes to data branch
      run: |
        cd ref-data

        # è®¾ç½®Gité…ç½®ä»¥å¤„ç†è‡ªåŠ¨åˆå¹¶ / Set Git config for automatic merging
        git config pull.rebase true
        git config rebase.autoStash true

        # å°è¯•æ¨é€ä»£ç å˜æ›´åˆ° data åˆ†æ”¯ / Try to push code changes to data branch
        for i in {1..3}; do
          echo "æ¨é€ä»£ç å˜æ›´å°è¯• $i / Push code changes attempt $i"
          if git push origin data; then
            echo "âœ… æ¨é€æˆåŠŸ / Push successful"
            break
          else
            echo "ğŸŸ¡ æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°å˜æ›´... / Push failed, pulling latest changes..."
            git pull origin data --no-edit || true
            if [ $i -eq 3 ]; then
              echo "âŒ 3æ¬¡å°è¯•åæ¨é€å¤±è´¥ / Failed to push after 3 attempts"
            fi
          fi
        done
